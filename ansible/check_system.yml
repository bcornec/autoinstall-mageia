- name: Load variables generated at install time
  ansible.builtin.include_vars: "{{ MGALOCAL }}/etc/mageia.yml"

- name: Load variables generated with autoinstall-mageia if any
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
      - "{{ MGALOCAL }}/autoinstall/mageia.yml"
      skip: true

- name: Check for installed packages
  ansible.builtin.include_tasks: "{{ MGAANSIBLEDIR }}/install_pkgs.yml"

- name: Ensure correct nproc soft limits
  become: true
  become_user: root
  community.general.pam_limits:
    domain: "{{ MGAUSER }}"
    limit_type: soft
    limit_item: nproc
    value: "800000"

- name: Ensure correct nproc hard limits
  become: true
  become_user: root
  community.general.pam_limits:
    domain: "{{ MGAUSER }}"
    limit_type: hard
    limit_item: nproc
    value: "800000"

- name: Ensure correct nofile soft limits
  become: true
  become_user: root
  community.general.pam_limits:
    domain: "{{ MGAUSER }}"
    limit_type: soft
    limit_item: nofile
    value: "65535"

- name: Ensure correct nofile hard limits
  become: true
  become_user: root
  community.general.pam_limits:
    domain: "{{ MGAUSER }}"
    limit_type: hard
    limit_item: nofile
    value: "65535"

- name: Setup sysctl params
  become: true
  become_user: root
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: true
    sysctl_set: true
  with_items:
    - { key: "net.ipv4.tcp_keepalive_time", value: "1800" }
    - { key: "kernel.threads-max", value: "4096000" }
    - { key: "kernel.pid_max", value: "200000" }
    - { key: "vm.max_map_count", value: "600000" }

- name: Ensure limits are correct for "{{ MGAUSER }}" account
  lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: "{{ item }}"
  with_items:
    - "ulimit -u 641465"
    - "ulimit -n 65535"

- name: Copy the skeleton content under /etc/skel
  become: true
  become_user: root
  ansible.posix.synchronize:
    dest: /etc/skel/
    src: '{{ MGAREPODIR }}/skel/'

- name: Test .profile file
  ansible.builtin.command: ls "{{ ansible_env.HOME }}/.profile"
  register: profile_path
  failed_when: false
  changed_when: false

- name: Ensure we have a .profile file
  ansible.builtin.copy:
    src: /etc/skel/.bash_profile
    dest: "{{ ansible_env.HOME }}/.profile"
  when:
    - profile_path.rc != 0

- name: Ensure vim is the default EDITOR
  lineinfile:
    path: "{{ ansible_env.HOME }}/.profile"
    line: export EDITOR=vim

- name: Setup logind.conf
  become: true
  become_user: root
  lineinfile:
    path: /etc/systemd/logind.conf
    line: UserTasksMax=100000
    state: present

- name: Copy sshutout configuration file
  become: true
  become_user: root
  template:
    src: templates/sshutout.conf
    dest: /etc
    owner: root
    group: root
    mode: 0640
    backup: yes
  notify:
    - restart sshutout

- name: 'Check ssh public keys for admins'
  become: true
  become_user: root
  ansible.posix.authorized_key:
    user: {{ MGAADMININS }}
    state: present
    key: "{{ lookup('file', '{{ MGAANSIBLEDIR }}/skel/{{ item }}_pub_keys') }}"
    with_items: 
      - "{{ MGAADMININS }}"
      - "{{ MGAUSER }}"

- name: "Check public network configuration"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/sysconfig/ifcfg-pubif.j2"
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ MGAMACHINEPUBITF }}"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644

- name: "Check default network route"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/sysconfig/network.j2"
    dest: "/etc/sysconfig/network"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644

- name: "Check resolver"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/etc/resolv.conf.j2"
    dest: "/etc/resolv.conf"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644

- name: "Check internal network configuration"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/sysconfig/ifcfg-iif.j2"
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ MGAMACHINEIITF }}"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644

- name: "fix hostname"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/etc/hostname.j2"
    dest: "/etc/hostname"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644

- name: Adds real network interfaces in case of pub bonding
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/sysconfig/ifcfg-pubslave.j2"
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ item }}"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644
  when: MGAMACHINEPUBITF.startswith('bond')
  loop: "{{ MGAMACHINEPUBSLAVE | split(',') }}"

- name: Adds real network interfaces in case of internal bonding
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/sysconfig/ifcfg-islave.j2"
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ item }}"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0644
  when: MGAMACHINEIITF.startswith('bond')
  loop: "{{ MGAMACHINEISLAVE | split(',') }}"

- name: Configure bonding module
  become: true
  become_user: root
  lineinfile:
    path: /etc/modules-load.d/modules.conf
    line: "alias {{ item }} bonding\noptions {{ item }} miimon=100 mode=4"
  when: item.startswith('bond')
  with_items:
    - "{{ MGAMACHINEPUBITF }}"
    - "{{ MGAMACHINEIITF }}"

- name: "Generate shorewall rules"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/shorewall/{{ item | basename }}"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0640
    backup: yes
  with_fileglob: [ '{{ MGAANSIBLEDIR }}/templates/shorewall/rules*', '{{ MGAANSIBLEDIR }}/templates/shorewall/interfaces' ]
  notify:
    - restart shorewall

- name: "Generate mga-check-network"
  become: true
  become_user: root
  ansible.builtin.template:
    src: "{{ MGAANSIBLEDIR }}/templates/bin/mga-check-network"
    dest: "/usr/local/bin/mga-check-network"
    owner: "{{ MGAUSER }}"
    group: "{{ MGAUSER }}"
    mode: 0755
    backup: yes

- name: Setup crontab for daily conformity check
  become: true
  become_user: root
  ansible.builtin.cron:
    name: mga-check-srv
    minute: "{{ 59 | random(seed=inventory_hostname) }} "
    hour: "04"
    user: "{{ MGAUSER }}"
    job: "{{ MGALOCAL }}/bin/mga-check-srv"
    cron_file: mga-check-srv
    state: present

- name: Start base services
  become: true
  become_user: root
  ansible.builtin.systemd:
    state: started
    daemon_reload: true
    enabled: true
    name: "{{ item.1 }}"
  loop: "{{ nodes | subelements('svcs', { 'skip_missing': true })}}"
  when: item.0.name == "system"
